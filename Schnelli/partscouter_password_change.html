<!DOCTYPE html>
<html lang="en-US">
<title>PartScouter Password Change</title>

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <link rel="stylesheet" type="text/css" href="styles.css" />
  <script src="external/firebasejs/8.9.1/firebase-app.js"></script>
  <script src="external/firebasejs/8.9.1/firebase-database.js"></script>
  <script src="external/firebasejs/8.9.1/firebase-auth.js"></script>
</head>

<style>
  input {
    width: 200px;
    display: block;
    margin: auto;
  }

  p {
    width: 100%;
    text-align: center;
  }

  h2 {
    width: 100%;
    text-align: center;
  }

  button {
    width: 200px;
    display: block;
    margin: auto;
  }
</style>

<body>
  <div class="hide" id="snackbar" style="display: none; z-index: 4;"></div>
  <h2>PartScouter Password Change</h2>

  <p>Email</p>
  <input type="text" id="email">
  <p>Old Password</p>
  <input type="password" id="old_password">
  <br><br><br><br>
  <p>New Password</p>
  <input type="password" id="new_password">
  <p>Confirm Password</p>
  <input type="password" id="confirm_password">
  <br>
  <button id="button_confirm" onclick="confirm();">Confirm</button>
  <div id="loader" class="loader" style="display: none; margin: auto;"></div>
</body>


<script>
  const queryString = window.location.search;
  // ?product=shirt&color=blue&newuser&size=m
  const urlParams = new URLSearchParams(queryString);
  const emailq = urlParams.get('email');
  if (emailq != null) {
    document.getElementById("email").value = emailq;
    document.getElementById("old_password").value = emailq;
  }

  var firebaseConfig = {
    apiKey: "AIzaSyBiHDF9LJepi4QyOhHeayZT_etKN5AjlGs",
    authDomain: "appliance-parts-f45cd.firebaseapp.com",
    databaseURL: "https://appliance-parts-f45cd.firebaseio.com",
    projectId: "appliance-parts-f45cd",
    storageBucket: "appliance-parts-f45cd.appspot.com",
    messagingSenderId: "671454569102",
    appId: "1:671454569102:web:479b1d3a11bedf601c1fdf"
  };
  // const app = initializeApp(firebaseConfig);
  firebase.initializeApp(firebaseConfig);

  var _snackbar_times_shown = 0;
  function showSnackbar(message, time_to_show) {
    var x = document.getElementById("snackbar");
    x.style.display = "";
    x.innerHTML = message;
    if (x.className != "hide")
      if (x.className == "refresh1")
        x.className = "refresh2";
      else
        x.className = "refresh1";
    else
      x.className = "show";
    ++_snackbar_times_shown;

    setTimeout(function () {
      --_snackbar_times_shown;
      if (_snackbar_times_shown == 0) {
        x.className = "hide";

        setTimeout(function () {
          x.style.display = "none";
        }, 500);

      }
    }, time_to_show);
    centerSnackbar(x);
  }

  function centerSnackbar(ele) {
    var left = (window.innerWidth - ele.clientWidth) / 2;
    ele.style.left = left + "px";
  }

  function confirm() {
    document.getElementById("button_confirm").style.display = "none";
    document.getElementById("loader").style.display = "block";

    var newPassword1 = document.getElementById("new_password").value;
    var newPassword2 = document.getElementById("confirm_password").value;
    if (newPassword1 != newPassword2) {
      showSnackbar("Passwords don't match", 5000);
      document.getElementById("button_confirm").style.display = "";
      document.getElementById("loader").style.display = "none";
      return;
    }

    if (newPassword1.length < 6) {
      showSnackbar("Password must be at least 6 characters in length", 5000);
      document.getElementById("button_confirm").style.display = "";
      document.getElementById("loader").style.display = "none";
      return;
    }

    firebase.auth().signInWithEmailAndPassword(document.getElementById("email").value, document.getElementById("old_password").value)
      .then((userCredential) => {
        console.log("signInWithEmail:success " + firebase.auth().getUid());
        firebase.auth().currentUser.updatePassword(newPassword1)
          .then(() => {
            showSnackbar("Password updated successfully!", 20000);
            document.getElementById("button_confirm").style.display = "";
            document.getElementById("loader").style.display = "none";
          }).catch((error) => {
            console.log("updatePassword:failure|" + error.code + "|" + error.message);
            showSnackbar(error.message, 5000);
            document.getElementById("button_confirm").style.display = "";
            document.getElementById("loader").style.display = "none";
          });
      }).catch((error) => {
        console.log("signInWithEmail:failure|" + error.code + "|" + error.message);
        showSnackbar(error.message, 5000);
        document.getElementById("button_confirm").style.display = "";
        document.getElementById("loader").style.display = "none";
      });
  }
</script>

</html>